% ОБЯЗАТЕЛЬНО ИМЕННО ТАКОЙ documentclass!
% (Основной кегль = 14pt, поэтому необходим extsizes)
% Формат, разумеется, А4
% article потому что стандарт не подразумевает разделов
% Глава = section, Параграф = subsection
% (понятия "глава" и "параграф" из документа, описывающего диплом)
\documentclass[a4paper,article,14pt]{extarticle}

% Подключаем главный пакет со всем необходимым
\usepackage{spbudiploma_tempora}

% Пакеты по желанию (самые распространенные)
% Хитрые мат. символы
\usepackage{euscript}
% Таблицы
\usepackage{longtable}
\usepackage{makecell}
% Картинки (можно встявлять даже pdf)
\usepackage[pdftex]{graphicx}

\usepackage{amsthm,amssymb, amsmath}
\usepackage{textcomp}

\begin{document}

% Титульник в файле titlepage.tex
%\input{titlepage.tex}

% Содержание
\tableofcontents
\pagebreak

\specialsection{Введение}

В настоящее время обучение языку ассемблера является важной составляющей многих программистских курсов.

Очень часто студенты, изучающие язык ассемблера, сталкиваются с проблемами при настройки среды разработки, при использовании инструментов компиляции и отладки.

Преподаватели таких курсов также сталкиваются с проблемами организации учебного процесса.

Создание удобного, интерактивного и производительного программного инструмента удалённой сборки и отладки програм на ассемблере, представляет собой актуальную задачу.

\specialsection{Постановка задачи}

\textbf{Цель данной работы} состоит в разработке обучающего веб-инструмента удалённого запуска, отладки и проверки программ на языке ассемблера.

\textbf{Задачи данной работы}:

\begin{enumerate}
    \item Исследование существующих решений для запуска и отладки программ на языке ассемблера, а также решений для обучения языку ассемблера.
    \item Формирование требований к разрабатываемому инструменту.
    \item Исследование возможности создания инструмента.
    \item Разработка программной архитектуры инструмента.
    \item Реализация инструмента.
    \item Исследование свойств решения.
\end{enumerate}

\textbf{Объектом исследования} являются системы запуска и отладки программ на языке ассемблера.

\textbf{Предметом исследования} является интерактивность и удобство использования таких систем.

\textbf{Практическая ценность работы} состоит в том, что разработанный инструмент позволит проводить обучение языку ассемблера более эффективно для студентов.

\section{Обзор предметной области}
\subsection{Критерии сравнения}

Смотрим на следующие критерии:

\begin{enumerate}
    \item Поддержка запуска ассемблерного кода на разных диалектах и на разных архитектурах.
    \item Поддержка отладки: выполнение по шагам, поддержка точек останова, редактирования регистров/памяти, визуализация стека вызовов.
    \item Поддержка задач и их автоматической проверки.
    \item Поддержка интеграции с системами управления обучением.
    \item Возможность работы без установки дополнительного программного обеспечения на устройстве пользователя.
    \item Возможность самостоятельной установки и развёртывания системы на выделенном сервере, доступность исходного кода.
\end{enumerate}

\subsection{Существующие решения}
\subsubsection{Ideone}

Ideone\footnote{\url{https://ideone.com}} является онлайн компилятором и средой разработки, поддерживающей более 60 языков программирования, в том числе несколько диалектов ассемблера.

Поддерживается запуск ассемблерного кода на архитектурах x86 (NASM и GNU диалекты) и x86-64 (только NASM диалект). Отладка не поддерживается.

Поддержки задач, их автоматической проверки нет, соответственно нет и интеграции в системы управления обучением.

Взаимодействие с системой происходит через веб-интерфейс, установки допольнительного ПО не требуется.

Система имеет закрытый исходный код, самостоятельно установить систему на выделенный сервер не представляется возможным.

\subsubsection{OneCompiler}

OneCompiler\footnote{\url{https://onecompiler.com/assembly}}~--- это примерно то же самое, что и Ideone, правда поддерживает только x86 с NASM диалектом. Не уверен, нужно ли включать в список аналогов, или же хватит Ideone.

\subsubsection{ASM Debugger}

ASM Debugger\footnote{\url{http://asmdebugger.com}} является инструментом для пошаговой отладки простых программ на языке ассемблера.

Особенностью инструмента является то, что он не использует запуск программ на реальном аппаратном обеспечении. Вместо этого, на языке Javascript реализовано подмножество инструкций x86 ассемблера.

Поддерживается запуск ассемблерного кода на архитектуре x86 с NASM диалектом. Поддерживается пошаговое исполнение, просмотр значений регистров.

Поддержки задач, их автоматической проверки нет, соответственно нет и интеграции в системы управления обучением.

Взаимодействие с инструменетом происходит через веб-интерфейс, установки допольнительного ПО не требуется.

Инструмент имеет открытый исходный код\footnote{\url{https://github.com/dinoqqq/asmdebugger}}, соответственно есть возможность установить его на выделенный сервер.

\subsubsection{SASM (SimpleASM)}

SASM\footnote{\url{https://dman95.github.io/SASM/index.html}} представляет из себя кроссплатформенную среду разработки на языке ассемблера для архитектур x86 и x86-64 с использованием диалектов NASM, GNU, FASM, MASM.

Поддерживается запуск ассемблерного кода, поддерживается выполнение по шагам, точки останова, просмотр и редактирование регистров и памяти, а также произвольные команды GDB.

Поддержки задач, их автоматической проверки нет, соответственно нет и интеграции в системы управления обучением.

Для использования инструмента необходима его установка на компьютер пользователя. Инструмент имеет открытый исходный код\footnote{\url{https://github.com/Dman95/SASM}}.

\subsubsection{JetBrains Clion + EduTools}

Clion\footnote{\url{https://www.jetbrains.com/clion/}}~--- это интегрированная среда разработки от компании JetBrains, предназначенная, в первую очередь, для разработки приложений на языках C и C++. Язык ассемблера не поддерживается ни в каком виде, но существуют сторонние плагины, которые решают эту проблему, например NASM Assembly Language\footnote{\url{https://plugins.jetbrains.com/plugin/9759-nasm-assembly-language}}.

Компиляция и запуск кода на языке ассемблера возможны, если модифицировать должным образом файлы системы описания сборки CMake. Отладка ассемблерного кода не поддерживается.

Плагин EduTools\footnote{\url{https://plugins.jetbrains.com/plugin/10081-edutools}} позволяет создавать и писать задачи с автоматическими тестами, что упрощает проверку решений. Отсутствует поддержка задач с закрытыми (недоступными для обучающегося) тестами. Интеграция с системами управления обучением отсутствует.

Для использования данной среды разработки необходима её установка на компьютер пользователя. Она имеет закрытый исходный код.

\subsubsection{GitHub Classroom + Visual Studio Code}

GitHub Classroom~--- это сервис, позволяющий давать учебные задания в виде git-репозиториев. GitHub Classroom позволяет добавить кнопку <<открыть в Visual Studio Code>>, которая позволяет открыть репозиторий с преднастроенными плагинами в этом редакторе.

Для того, чтобы настроить поддержку языка ассемблера в Visual Studio Code, требуется установка дополнительных плагинов. Также преподавателю в шаблонном репозитории необходимо будет настроить компиляцию и запуск в файлах \texttt{tasks.json} и \texttt{launch.json}. Отладка не поддерживается.

GitHub Classroom позволяет добавлять тесты через веб-интерфейс преподавателя. В качестве теста может выступать набор входных данных и эталонных ответов к ним, так и путь до скрипта для автоматической проверки. В первом случае входные данные передаются программе через стандартный поток ввода, а вывод программы сравнивается с эталонным ответом.

Необходима установка Visual Studio Code, компилятора и отладчика.

GitHub Classroom имеет закрытый исходный код, установить свою копию на выделенный сервер не представляется возможным.

\subsubsection{Stepik}

В системе управления обучением Stepik есть режим задания Code Challenge, который позволяет проверять код, написанный на различных языках программирования.

Поддерживается NASM диалект x86 и x86-64 ассемблера. Отладка не поддерживается.

Поддерживаются задачи и их автоматическая проверка на скрытых тестах. Тесты должны иметь вид набора входных данных и эталонных ответов. Входные данные передаются программе через стандартный поток ввода, а вывод программы сравнивается с эталонным ответом.

Взаимодействие с системой происходит через веб-интерфейс, установка дополнительного ПО не требуется. Система имеет закрытый исходный код.

\subsubsection{Moodle + Virtual Programming Lab}

Для системы управления обучением Moodle существует плагин Virtual Programming Lab, котторый позволяет запускать и проверять код, написанный на различных языках программирования.

Поддерживается NASM диалект x86 ассемблера, отладка не поддерживается.

Поддерживаются задачи и их автоматическая проверка на скрытых тестах. Тесты должны иметь вид набора входных данных и эталонных ответов. Входные данные передаются программе через стандартный поток ввода, а вывод программы сравнивается с эталонным ответом.

Взаимодействие с системой происходит через веб-интерфейс, установка дополнительного ПО не требуется. И система Moodle и плагин Virtual Programming Lab имеют открытый исходный код. Соответственно, есть возможность установки этой связки на выделенный сервер.

\subsubsection{Git репозиторий с заданиями и скриптами для проверки}

Сюда тоже надо что-то написать, но я пока не понимаю как это лучше оформить.

\subsection{Сравнение существующих решений}

Тут табличка с ранее описанными критериями сравнения.

\section{Формулировка требований к решению}

\subsection{Функциональные требования}

Разрабатываемый инструмент должен удовлетворять следующим функциональным требованиям:

\begin{enumerate}
    \item Инструмент должен быть доступен через веб-интерфейс и не требовать установки допольнительного программного обеспечения на устройстве пользователя.
    \item Инструмент должен содержать возможность аутентификации пользователей, как по паре логин/пароль, так и через протокол LTI.
    \item Должна существовать возможность разделения прав пользователей на администраторов и учащихся.
    \item Администраторы должны иметь возможность создавать, редактировать и удалять задачи.
    \item Каждая задача должна иметь: название, текст условия, связанный с ней чекер и его параметры.
    \item Учащиеся должны уметь получать задания по конкретным задачам через системы управления обучением. Для этого администратор такой системы должен настроить LTI интеграцию, в частности, указать идентификатор нужной задачи.
    \item На странице задания для учащегося должно быть доступно условие задачи, редактор кода, возможность отправить решение на проверку и информация о предыдущих попытках решения.
    \item Вместе с редактором кода должна быть доступна функциональность отладки: добавление и удаление точек останова, запуск, остановка, пошаговое исполнение программы. Если программа находится в приостановленном состоянии, должен быть доступен просмотр и редактирование регистров процессора и содержимого памяти процесса.
    \item Запускаемые пользовательские программы должны быть ограничены по времени и используемой памяти, им должен быть запрещен доступ к файловой системе, сети, процессам и другим ресурсам операционной системы.
\end{enumerate}

\subsection{Нефункциональные требования}

\begin{enumerate}
    \item Инструмент, в первую очередь, предназначается для задач, направленных непосредственно на изучение языка ассемблера. Таким образом, задачи должны быть составлены так, чтобы их решения могли исполняться в контексте непривилегированных процессов пользовательского пространства, без доступа к конкретным системным вызовам и периферии.
    \item Инструмент должен минимизировать количество элементарных шагов, требуемых для запуска программ.
    \item Инструмент должен быть эффективен по использованию процессорного времени и оперативной памяти.
    \item Инструмент должен обладать достаточным быстродействием и отзывчивостью.
\end{enumerate}

\section{Описание метода решения}

\subsection{Компиляция ассемблерных программ}

Используем GCC. Поддерживаются директивы \texttt{\#line}, таким образом можно чинить номера строк с отладочной информации и сообщениях об ошибках.

\subsection{Запуск ассемблерных программ}

\subsubsection{Изоляция с помощью seccomp}

Seccomp~--- механизм ядра Linux, позволяющий процессу перейти в <<безопасный режим>>, в котором запрещены все системные вызовы, кроме \texttt{exit}, \texttt{sigreturn}, \texttt{read} и \texttt{write}. Запретить работать со стандартными потоками ввода/вывода можно, предварительно вызвав \texttt{close} на них.

Здесь можно привести листинг кода, который переводит программу в безопасный режим. Код этот живёт в файле \texttt{environment/x86\_64/entry.S}.

\subsubsection{Ограничение потребляемых ресурсов с помощью Docker}

Docker (через механизм контрольных групп) позволяет ограничивать использование процессорного времени, используемую память в контейнерах.

Существует системный вызов \texttt{setrlimit}. Ограничиваем процессорное время в секундах через \texttt{RLIM\_CPU}. Docker умеет это делать через параметр \texttt{ulimit}.

\subsection{Отладка ассемблерных программ}

\subsubsection{Использование GDB}

GDB~--- консольный инструмент отладки программ. Позволяет отлаживать программы на самых разных языках программирования на разных платформах. Поддерживает отладочную информацию в формате DWARF.

\subsubsection{GDB/MI}

GDB/MI (GDB Machine Interface, машинный интерфейс GDB) позволяет взаимодействовать с процессом отладки в машиночитаемом виде. Это нам пригодится.

Тут можно вкратце описать формат взаимодействия, сослаться на мануал GDB/MI.

\subsubsection{GDB server}

GDB server~--- программа, с которой GDB может взаимодействовать, чтобы организовать отладку кода на удалённой машине. Пригодится для разделения полномочий и ограничения ресурсов.

\subsection{Взаимодействие с пользователем через веб-браузер}

Для интерактивной отладки необходимо не только передавать команды из веб-интерфейса в GDB, но и асинхронно реагировать на события, возникающие при отладки. К таким событиям, например, относится остановка программы на точке останова. К счастью, все современные браузеры поддерживают протокол WebSocket, который позволяет общаться клиенту и серверу полностью асинхронно, а не по модели запрос-ответ.

\subsection{Взаимодействие с системами управления обучением}

Существует такой протокол: LTI, Learning Tools Interoperability. В частности, позволяет по протоколу OAuth авторизовывать пользователей конкретной LMS, получать информацию о таске, а также отправлять результаты проверки как score от 0.0 до 1.0.

\subsection{Сбор метрик}

Поднимаем Prometheus, пишем туда нужные метрики. Идеи для релевантных метрик: задержка исполнения команд gdb, время реакции на команды пользователя, общее потребление памяти на процесс отладки (gdb + gdbserver + программа), потребление cpu на процесс отладки (интересует idle cpu usage).

\section{Архитектура программной организации}

\subsection{Требования к архитектуре}

Хотим поддержать несколько вещей: интерактивную отладку, неинтерактивную проверку решений, интеграцию с LTI, админский интерфейс и прочие неинтересности. Поэтому имеет смысл выделить сервис, который будет заниматься именно взаимодействием с GDB.

\subsection{Использованные технологии}

\subsubsection{Flask}
Используем flask, потому что много плагинов для самых разных задач, необходимых в проекте: аутентификация, LTI, админка.

\subsubsection{Asyncio + aiohttp}
Используем asyncio и aiohttp в раннере, потому что хотим асинхронности и производительности.

\subsubsection{Postgresql}
Используем postgres как слой персистентности, потому что хотим надёжности и имеем нормализованные данные.

\subsubsection{Redis}
Используем redis для хранения nonceов, потому что хотим key-value хранилище с быстрым доступом и автоматической очисткой.

\subsubsection{Nginx}
Используем nginx, потому что хотим балансер, который позволяет направлять разные урлы на разные апстримы.

\subsubsection{Docker}
Потому что это всё надо изолировать же как-то. Docker compose для того чтобы не сойти с ума со всеми этими сервисами.

\subsection{Схема архитектуры}

Здесь нужна схема всего этого безобразия, она в целом такая: за балансером живёт статика, фласк и раннер. Фласк общается с БД и раннером, раннер сам по себе живёт, создаёт и убивает контейнеры с запущенными программами. Prometheus опрашивает стат-ручки в раннере и фласке.

\subsection{Интерфейс пользователя}

\subsubsection{Аутентификация через логин и пароль}

Есть у нас страница \texttt{/login}. Ожидается, что так входят только админы.

\subsubsection{Аутентификация через LTI}

При правильно настроенном Moodle, достаточно зайти на страницу задания и увидеть iframe с интерфейсом пользователя, вход происходит автоматически. Под капотом нам POST запрос к ручке \texttt{/lti} с нужными параметрами.

Скриншот мудла с iframeом.

\subsubsection{Работа с интерактивным отладчиком через GUI}

Можно ставить брейкпоинты, можно слать команды, можно смотреть на регистры. Обратите вниманеи на красивый редактор. Скриншот в paused состоянии.

\subsubsection{Работа с админской панелью}

Есть несколько сущностей: пользователи, задачи, задания и посылки, с ними работа ведётся одинаково.

\subsection{Модель данных}

\subsubsection{Схема базы данных}

Тут схема, которую как-то надо нарисовать.

\subsubsection{Таблица users}

Содержит в себе данные о пользователях, в том числе и метод аутентификации (password или LTI).

\subsubsection{Таблица problems}

Содержит информацию о задачах, в том числе и чекер.

\subsubsection{Таблица assignments}

Задания, выданные студентам. Содержит, помимо прочего, LTI callback и оценку.

\subsubsection{Таблица submissions}

Содержит посылки по задачам.

\section{Исследование свойств решения}

\specialsection{Выводы}

Ну вот написали инструмент, все задачи поставленные во введении сделали, студент заслуживает оценки <<отлично>> и присвоения степени бакалавра.

\specialsection{Заключение}

Чем это отличается от выводов? Не знаю, но шаблон СПбГУ требует.

% Библиография в cpsconf стиле
% Аргумент {1} ниже включает переопределенный стиль с выравниванием слева
\begin{thebibliography}{1}
% \bibitem{voc} Griffin D.W., Lim J.S. \flqq Multiband excitation vocoder\frqq. IEEE ASSP-36 (8), 1988, pp. 1223-1235.
% \bibitem{vo2} Griffin D.W., Lim J.S. \flqq Multiband excitation vocoder\frqq. IEEE ASSP-36 (8), 1988, pp. 1223-1235.
\end{thebibliography}
\end{document}
